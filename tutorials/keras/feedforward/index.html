<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keras Feedforward Tutorial &mdash; Vict0rsch</title>
    
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet" type="text/css">
    <!-- <link rel="stylesheet" href="/assets/main.css"> -->

    <link rel="stylesheet" type="text/css" href="/assets/main-52ae7e3dfe5a5913b1a1f11b64d5f74b05fbe724da7d42f261065884084029ab.css" integrity="sha256-Uq5+Pf5aWROxofEbZNX3SwX75yTafULyYQZYhAhAKas=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/assets/tingle-141cb380cbc51d7fad4249751d1e3cffb07ccff80f6b0836164a30c2b857bf2a.css" integrity="sha256-FByzgMvFHX+tQkl1HR48/7B8z/gPawg2FkowwrhXvyo=" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="/assets/tingle.css"> -->

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/light-bulb.svg" />
    <!--rss-feed <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Vict0rsch" /> -->
    <meta name="title" content="Keras Feedforward Tutorial ">
    <link rel="canonical" href="https://vict0rs.ch/tutorials/keras/feedforward/">
    
    
    <meta property="og:title" content="Keras Feedforward Tutorial " />
    <meta property="og:url" content="https://vict0rs.ch/tutorials/keras/feedforward/" />
    
    
    <meta property="og:description" content="Vict0rsch's blog about tech and AI - PhD Student @MILA, Montreal, Quebec" />
    <meta name="description" content="Vict0rsch's blog about tech and AI - PhD Student @MILA, Montreal, Quebec" />
    
    <meta property="og:site_name" content="Vict0rsch">
    
    <!--google analytics tracking code here-->
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-88678459-1', 'auto');
 ga('send', 'pageview');
 
 console.log('gogol analytics')
</script>

    
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
<style>
#nprogress{pointer-events:none}#nprogress .bar{background:#2077b2;position:fixed;z-index:1031;top:0;left:0;width:100%;height:3px}#nprogress .peg{display:block;position:absolute;right:0;width:100px;height:100%;box-shadow:0 0 10px #2077b2,0 0 5px #2077b2;opacity:1;-webkit-transform:rotate(3deg) translate(0px,-4px);-ms-transform:rotate(3deg) translate(0px,-4px);transform:rotate(3deg) translate(0px,-4px)}#nprogress .spinner{display:block;position:fixed;z-index:1031;top:15px;right:15px}#nprogress .spinner-icon{width:18px;height:18px;box-sizing:border-box;border:solid 2px transparent;border-top-color:#2077b2;border-left-color:#2077b2;border-radius:50%;-webkit-animation:nprogress-spinner 400ms linear infinite;animation:nprogress-spinner 400ms linear infinite}.nprogress-custom-parent{overflow:hidden;position:relative}.nprogress-custom-parent #nprogress .spinner,.nprogress-custom-parent #nprogress .bar{position:absolute}@-webkit-keyframes nprogress-spinner{0%{-webkit-transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg)}}@keyframes nprogress-spinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>

</head>

<body>
    <script>
        NProgress.configure({
            easing: 'ease',
            speed: 600,
            showSpinner: false,
        });
        NProgress.start();
        var int = setInterval(()=> {
            NProgress.inc()
        }, 500)
        window.onload = function(){
            clearInterval(int);
            NProgress.done();
        };
    </script>

    <div id='wrapper'>
        <div id='main'>
            <section id="navbar" class="site-nav">
                <header>
                    <nav id="navigation">
                        <a class="brand" href="/">
                            <img src="/images/light-bulb.svg" alt="Home"><span class="hidable-nav">Home</span>
                        </a>
                        
                        <a href="/resources">Resources</a>
                        
                        <a href="/about">About</a>
                        
                        
                        <a href="#" class='search-link'>
                                <span class="hidable-nav">Search</span> <i class="fa fa-search"></i>
                        </a>
                        
                    </nav>
                    <nav class="tagline">
                        <span>Learn Keras and Lasagne (2015)</span>
                        <a href="/tutorials" class="btn btn-outline">Tutorials</a>
                    </nav>
                </header>
            </section>

            
<article>
    <div class="container">
        <header>
            
            <h1 class="title">Keras Feedforward Tutorial</h1><span id='title_buttons'><a id='night_mode' class="btn btn-outline dark">Read
                    in the dark</a></span>
            <h2 class="subtitle">Code walk-through - Jan. 2016</h2>
        </header>

        <section>
            <div id='post-content'>
                <p>This section will walk you through the code of <a href="https://github.com/Vict0rSch/deep_learning/blob/master/keras/feedforward/feedforward_keras_mnist.py"><code class="language-plaintext highlighter-rouge">feedforward_keras_mnist.py</code></a>, which I suggest you have open while reading. This tutorial is based on several Keras examples and from it’s documentation :</p>

<ul>
  <li><strong><a href="https://github.com/fchollet/keras/blob/master/examples/mnist_mlp.py">mnist_mlp.py example</a></strong></li>
  <li><strong><a href="http://keras.io/datasets/#mnist-database-of-handwritten-digits">mnist dataset in Keras</a></strong></li>
  <li><strong><a href="http://keras.io/callbacks/#example-recording-loss-history">Loss history callback</a></strong></li>
</ul>

<p>If you are not yet familiar with what mnist is, please spend a couple minutes <a href="http://yann.lecun.com/exdb/mnist/">there</a>. It is basically a set of hadwritten digit images of size $\left{ 2*3 \right}$ in greyscale (0-255). There are 60,000 training examples and 10,000 testing examples. The training examples could be also split into 50,000 training examples and 10,000 validation examples.</p>

<p>By the way, Keras’s documentation is better and better (and it’s already good) and the <a href="https://groups.google.com/forum/#!forum/keras-users">community</a> answers fast to questions or implementation problems.</p>

<h4 id="keras-documentation"><a href="http://keras.io/">Keras Documentation</a></h4>

<h4 id="kerass-github"><a href="https://github.com/fchollet/keras">Keras’s Github</a></h4>

<h1 id="recognizing-handwritten-digits-with-keras">Recognizing handwritten digits with Keras</h1>

<h2 id="table-of-contents">Table of Contents</h2>
<p><strong><a href="#general-organization">General Organization</a></strong></p>

<p><strong><a href="#imports">Imports</a></strong></p>

<p><strong><a href="#callbacks">Callbacks</a></strong></p>

<p><strong><a href="#loading-the-data">Loading the Data</a></strong></p>

<p><strong><a href="#creating-the-model">Creating the Model</a></strong></p>

<p><strong><a href="#running-the-network">Running the Network</a></strong></p>

<p><strong><a href="#plot">Plot</a></strong></p>

<p><strong><a href="#usage">Usage</a></strong></p>

<h2 id="general-organization">General Organization</h2>

<p>We start with importing everything we’ll need (no shit…). Then we define the <code class="language-plaintext highlighter-rouge">callback</code> class that will be used to store the loss history. Lastly we define functions to load the data, compile the model, train it and plot the losses.</p>

<p>The overall philosophy is modularity. We use default parameters in the <code class="language-plaintext highlighter-rouge">run_network</code> function so that you can feed it with already loaded data (and not re-load it each time you train a network) or a pre-trained network <code class="language-plaintext highlighter-rouge">model</code>.</p>

<p>Also, don’t forget the Python’s <code class="language-plaintext highlighter-rouge">reload(package)</code>
function, very useful to run updates from your code without quitting (I)python.</p>

<h2 id="imports">Imports</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">np_utils</span>
<span class="kn">import</span> <span class="nn">keras.callbacks</span> <span class="k">as</span> <span class="n">cb</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers.core</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Activation</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">RMSprop</span>
<span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">time</code>, <code class="language-plaintext highlighter-rouge">numpy</code> and <code class="language-plaintext highlighter-rouge">matplotlib</code> I’ll assume you already know.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">np_utils</code> is a set of helper functions, we will only use <a href="https://github.com/fchollet/keras/blob/master/keras/utils/np_utils.py"><code class="language-plaintext highlighter-rouge">to_categorical</code></a> which i’ll describe later on.</li>
  <li><code class="language-plaintext highlighter-rouge">callbacks</code> is quite transparent, it is a customizable class that triggers functions on <a href="http://keras.io/callbacks/#usage-of-callbacks">events</a>.</li>
  <li><code class="language-plaintext highlighter-rouge">models</code> is the core of Keras’s neural networks implementation. It is the object that represents the network : it will have layers, activations and so on. It is the object that will be ‘trained’ and ‘tested’. <code class="language-plaintext highlighter-rouge">Sequetial</code> means we will use a ‘layered’ model, not a graphical one.</li>
  <li><code class="language-plaintext highlighter-rouge">layers</code> are the objects we stack on the <code class="language-plaintext highlighter-rouge">model</code>. There are a couple ways of using them, either include the <code class="language-plaintext highlighter-rouge">dropout</code> and <code class="language-plaintext highlighter-rouge">activation</code> parameters in the `
Dense<code class="language-plaintext highlighter-rouge"> layer, or treat them as </code>layers<code class="language-plaintext highlighter-rouge"> that will apply to the </code>model`’s last ‘real’ layer.</li>
  <li><code class="language-plaintext highlighter-rouge">optimizers</code> are the optimization algorithms such as the classic <a href="http://keras.io/optimizers/#sgd">Stochastic Gradient Descent</a>. We will use <code class="language-plaintext highlighter-rouge">RMSprop</code> (see <a href="https://www.youtube.com/watch?v=O3sxAc4hxZU">here</a> G. Hinton’s explanatory video and <a href="http://www.cs.toronto.edu/~tijmen/csc321/slides/lecture_slides_lec6.pdf">there</a> the slides)</li>
  <li><code class="language-plaintext highlighter-rouge">datasets</code> (in our case) will download the mnist dataset if it is not already in <code class="language-plaintext highlighter-rouge">~/.keras/datasets/</code> and load it into <code class="language-plaintext highlighter-rouge">numpy</code> arrays.</li>
</ul>

<h2 id="callback">Callback</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">LossHistory</span><span class="p">(</span><span class="n">cb</span><span class="p">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">on_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">logs</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'loss'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_loss</span><span class="p">)</span></code></pre></figure>

<p>The new class <code class="language-plaintext highlighter-rouge">LossHistory</code> extends Keras’s <code class="language-plaintext highlighter-rouge">Callback</code>class. It basically relies on two events:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">on_train_begin</code> -&gt; the event is clear : when the training begins, the callback initiates a list <code class="language-plaintext highlighter-rouge">self.losses</code> that will store the training losses.</li>
  <li><code class="language-plaintext highlighter-rouge">on_batch_end</code> -&gt; when a batch is done propagating forward in the network : we get its loss and append it to <code class="language-plaintext highlighter-rouge">self.losses</code>.</li>
</ul>

<p>This callback is pretty straight forward. But you could want to make it more complicated! Remember that callbacks are simply functions : you could do anything else within these. More on callbacks and available events <a href="http://keras.io/callbacks/">there</a>.</p>

<h2 id="loading-the-data">Loading the Data</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">load_data</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">'Loading data...'</span>
    <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>

    <span class="n">X_train</span> <span class="o">/=</span> <span class="mi">255</span>
    <span class="n">X_test</span> <span class="o">/=</span> <span class="mi">255</span>

    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np_utils</span><span class="p">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">np_utils</span><span class="p">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="p">(</span><span class="mi">60000</span><span class="p">,</span> <span class="mi">784</span><span class="p">))</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">784</span><span class="p">))</span>

    <span class="k">print</span> <span class="s">'Data loaded.'</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">]</span></code></pre></figure>

<p>Keras makes it very easy to load the Mnist data. It is split between train and test data, between examples and targets.</p>

<p>Images in mnist are greyscale so values are <code class="language-plaintext highlighter-rouge">int</code> between 0 and 255. We are going to rescale the inputs between 0 and 1 so we first need to change types from <code class="language-plaintext highlighter-rouge">int</code> to <code class="language-plaintext highlighter-rouge">float32</code> or we’ll get 0 when dividing by 255.</p>

<p>Then we need to change the targets. <code class="language-plaintext highlighter-rouge">y_train</code> and <code class="language-plaintext highlighter-rouge">y_test</code> have shapes <code class="language-plaintext highlighter-rouge">(60000,)</code> and <code class="language-plaintext highlighter-rouge">(10000,)</code>  with values from 0 to 9. We do not expect our network to output a value from 0 to 9, rather we will have 10 output neurons with <code class="language-plaintext highlighter-rouge">softmax</code> activations, attibuting the class to the best firing neuron (<code class="language-plaintext highlighter-rouge">argmax</code> of activations). <code class="language-plaintext highlighter-rouge">np_utils.to_categorical</code> returns vectors of dimensions <code class="language-plaintext highlighter-rouge">(1,10)</code> with 0s and one 1 at the index of the transformed number : <code class="language-plaintext highlighter-rouge">[3] -&gt; [0, 0, 0, 1, 0, 0, 0, 0, 0, 0]</code>.</p>

<p>Lastly we reshape the examples so that they are shape <code class="language-plaintext highlighter-rouge">(60000,784)</code>, <code class="language-plaintext highlighter-rouge">(10000, 784)</code> and not <code class="language-plaintext highlighter-rouge">(60000, 28, 28)</code>, <code class="language-plaintext highlighter-rouge">(10000, 28, 28)</code>.</p>

<h2 id="creating-the-model">Creating the model</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">init_model</span><span class="p">():</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">'Compiling Model ... '</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="mi">784</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s">'softmax'</span><span class="p">))</span>

    <span class="n">rms</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">rms</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
    <span class="k">print</span> <span class="s">'Model compield in {0} seconds'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></code></pre></figure>

<p>Here is the core of what makes your neural network : the <code class="language-plaintext highlighter-rouge">model</code>.<br />
We begin with creating an instance of the <code class="language-plaintext highlighter-rouge">Sequential</code> model. Then we add a couple hidden layers and an output layer. After that we instanciate the <code class="language-plaintext highlighter-rouge">rms</code> optimizer that will update the network’s parameters according to the RMSProp algorithm. Lastly we compile the model with the <a href="http://deeplearning.net/software/theano/library/tensor/nnet/nnet.html#tensor.nnet.categorical_crossentropy"><code class="language-plaintext highlighter-rouge">categorical_crossentropy</code></a> cost / loss / objective function and the optimizer. We also state we want to see the accuracy during fitting and testing.</p>

<p>Let’s get into the model’s details :</p>

<ul>
  <li>The first hidden layer is has 500 units, <a href="http://deeplearning.net/software/theano/library/tensor/nnet/nnet.html#theano.tensor.nnet.relu">rectified linear unit</a> activation function and 40% of dropout. Also, it needs the input dimension : by specifying <code class="language-plaintext highlighter-rouge">input_dim = 784</code> we tell this first layer that the virtual input layer will be of size 784.</li>
  <li>The second hidden layer has 300 units, rectified linear unit activation function and 40% of dropout.</li>
  <li>The output layer has 10 units (because we have 10 categories / labels in mnist), no dropout (of course…) and a <a href="http://deeplearning.net/software/theano/library/tensor/nnet/nnet.html#tensor.nnet.softmax">softmax</a> activation function to output a probability. <code class="language-plaintext highlighter-rouge">softmax</code> output + <code class="language-plaintext highlighter-rouge">categorical_crossentropy</code> is standard for multiclass classification.</li>
  <li>This structure 500-300-10 comes from Y. LeCun’s <a href="http://yann.lecun.com/exdb/mnist/">website</a> citing G. Hinton’s unpublished work</li>
  <li>Here I have kept the default initialization of weights and biases but you can find <a href="http://keras.io/initializations/">here</a> the list of possible initializations. Also, <a href="http://keras.io/activations/">here</a> are the possible activations.</li>
</ul>

<p>Remember I mentioned that Keras used Theano? well, you just went through it. Creating the <code class="language-plaintext highlighter-rouge">model</code>and <code class="language-plaintext highlighter-rouge">optimizer</code> instances as well as adding layers is all about creating Theano variables and explaining how they depend on each other. Then the compilation time is simply about declaring an undercover Theano function. This is why this step can be a little long. The more complex your model, the longer (captain here).</p>

<p>And yes, that’s it about Theano. Told you you did not need much!</p>

<h2 id="running-the-network">Running the network</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">run_network</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">init_model</span><span class="p">()</span>

        <span class="n">history</span> <span class="o">=</span> <span class="n">LossHistory</span><span class="p">()</span>

        <span class="k">print</span> <span class="s">'Training model...'</span>
        <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                  <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">history</span><span class="p">],</span>
                  <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">"Training duration : {0}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">"Network's test score [loss, accuracy]: {0}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span><span class="p">.</span><span class="n">losses</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">' KeyboardInterrupt'</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">history</span><span class="p">.</span><span class="n">losses</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">try/except</code> is there so that you can stop the network’s training without losing it.</p>

<p>With Keras, training your network is a piece of cake: all you have to do is call <code class="language-plaintext highlighter-rouge">fit</code> on your model and provide the data.</p>

<p>So first we load the data, create the model and start the loss history. All there is to do then is fit the network to the data. Here are <code class="language-plaintext highlighter-rouge">fit</code>’s arguments:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">X_train, y_train</code> are the training data</li>
  <li><code class="language-plaintext highlighter-rouge">nb_epoch</code> is perfecty transparent and <code class="language-plaintext highlighter-rouge">epochs</code> is defined when calling the <code class="language-plaintext highlighter-rouge">run_network</code>function.</li>
  <li><code class="language-plaintext highlighter-rouge">batch_size</code>idem as <code class="language-plaintext highlighter-rouge">nb_epoch</code>. Keras does all the work for you regarding epochs and batch training.</li>
  <li><code class="language-plaintext highlighter-rouge">callbacks</code> is a list of callbacks. Here we only provide <code class="language-plaintext highlighter-rouge">history</code> but you could provide any number of callbacks.</li>
  <li><code class="language-plaintext highlighter-rouge">validation_data</code> is, well, the validation data. Here we use the test data but it could be different. Also you could specify a <code class="language-plaintext highlighter-rouge">validation_split</code> float between 0 and 1 instead, spliting the training data for validation.</li>
  <li><code class="language-plaintext highlighter-rouge">verbose = 2</code> so that Keras displays both the training and validation loss and accuracy.</li>
</ul>

<h2 id="plot">Plot</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_losses</span><span class="p">(</span><span class="n">losses</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">'Loss per batch'</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span></code></pre></figure>

<p>Nothing much here, just that it is helpful to monitor the loss during training but you could provide any list here of course.</p>

<h2 id="usage">Usage</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">feedforward_keras_mnist</span> <span class="k">as</span> <span class="n">fkm</span>

<span class="n">model</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">fkm</span><span class="p">.</span><span class="n">run_network</span><span class="p">()</span>

<span class="n">fkm</span><span class="p">.</span><span class="n">plot_losses</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span></code></pre></figure>

<p>if you do not want to reload the data every time:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">feedforward_keras_mnist</span> <span class="k">as</span> <span class="n">fkm</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">fkm</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">model</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">fkm</span><span class="p">.</span><span class="n">run_network</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># change some parameters in your code
</span>
<span class="nb">reload</span><span class="p">(</span><span class="n">fkm</span><span class="p">)</span>
<span class="n">model</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">fkm</span><span class="p">.</span><span class="n">run_network</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></code></pre></figure>

<p>Using an Intel i7 CPU at 3.5GHz and an NVidia GTX 970 GPU, we achieve 0.9847 accuracy (1.53% error) in 56.6 seconds of training using this implementation (including loading and compilation).</p>

            </div>
            
<div class="social">
    
    <div class='custom_twitter_share'>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Keras Feedforward Tutorial" data-related="vict0rsch">Tweet</a>
    </div>
    
    
    <div class='custom_fb_share'>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    
    
</div>

        </section>

        <footer>
            <address>
                
                <p>
                    Written by <strong><a rel="author" href="https://twitter.com/vict0rsch" title=""
                            target="_blank">Victor Schmidt</a></strong>
                    <span class="muted"></span>
                    
                    &nbsp;- <iframe class='followGithub' src="https://ghbtns.com/github-btn.html?user=vict0rsch&type=follow&count=false&size=small"
                        frameborder="0" scrolling="0" width="220px" height="20px" align="top"></iframe>
                    
                </p>
                
                <div class='postDate'>Jan. 2016</div>
                
            </address>

        </footer>

        
        <section>
            <!-- <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-vict0rsch-github-io'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script> -->

        </section>
        
    </div>
</article>
        </div>
    </div>

    <footer class="site-footer" id="footer">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem">
            <div id="footer-subcontainer">
                <nav>
                    &copy; 2021
                    <!-- <a href=""></a> &middot; -->
                    <a href="/">Posts</a> &middot;
                    <a class="search-link" href="#">Search</a> &middot;
                    
                    <a href="/resources">Resources</a> &middot;
                    
                    
                    <a href="/about">About</a>
                    <span id="iframe-middot">
                        &middot;
                    </span>

                    
                    <div id="iframe-stars">
                        <iframe src="https://ghbtns.com/github-btn.html?user=vict0rsch&repo=deep_learning&type=star&count=true&size=small"
                            frameborder="0" scrolling="0" width="84px" height="20px" align="top"></iframe>
                    </div>
                </nav>
                <a class="brand" href="/" id="logo-footer">
                    <img src="/images/light-bulb.svg" alt="Home">
                </a>
            </div>
            <nav class="social" style="display: none">
                
                <!--<a href="https://twitter.com/vict0rsch" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a> -->
                
                
                <!--<a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss
                black"></i>
            </a> -->
            </nav>
        </div>
        <!-- <p style="text-align: center">Incorporated theme by <a href="https://sendtoinc.com">Inc</a></p> -->
    </footer>

    <script src="https://code.jquery.com/jquery-3.4.0.min.js"
  integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typeit@v6/dist/typeit.min.js" />

// <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.0/anchor.min.js"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<script integrity="sha256-OtUha0k2/9UfGo5Gk1z/sd7U+h+D976k0yB92whsPW4=" crossorigin="anonymous" src="/assets/jquery.details.min-3ad5216b4936ffd51f1a8e46935cffb1ded4fa1f83f7bea4d3207ddb086c3d6e.js" type="text/javascript"></script>
<script integrity="sha256-4wzmvLQ/OBBCfxELN4DUGzj7PW+xnN7NlI0d//TQB18=" crossorigin="anonymous" src="/assets/main-e30ce6bcb43f3810427f110b3780d41b38fb3d6fb19cdecd948d1dfff4d0075f.js" type="text/javascript"></script>
<script integrity="sha256-onGmRDUJ8Zf39A1uJov1b9pZtNzd5TxySBgWLJF0VY4=" crossorigin="anonymous" src="/assets/tingle-a271a6443509f197f7f40d6e268bf56fda59b4dcdde53c724818162c9174558e.js" type="text/javascript"></script>
<script integrity="sha256-CfaxBGUjUvpFlFRKgjFuU0wjm8nOSRE6pEV3OnmjJIc=" crossorigin="anonymous" src="/assets/search-09f6b104652352fa4594544a82316e534c239bc9ce49113aa445773a79a32487.js" type="text/javascript"></script>
<script integrity="sha256-bcehUY3Ujb9kllPCKFSl6b1nP5+Be8VJ9/5tW9wOLyQ=" crossorigin="anonymous" src="/assets/resourceCards-6dc7a1518dd48dbf649653c22854a5e9bd673f9f817bc549f7fe6d5bdc0e2f24.js" type="text/javascript"></script>




<script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');</script>



<div id="fb-root"></div>
<script>(function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>







<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    },
    "HTML-CSS": {
      scale: 90
    }
  });
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


</body>

</html>
